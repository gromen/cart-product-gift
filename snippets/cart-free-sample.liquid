{%- liquid
  # Check if the feature is enabled
  assign free_sample_enabled = settings.cart_free_sample_enabled | default: false
  unless free_sample_enabled
    break
  endunless

  # Get settings (threshold already in PLN, convert to grosze)
  assign threshold = settings.cart_free_sample_threshold | times: 100 | default: 25000
  assign sample_product_setting = settings.cart_free_sample_product
  assign progress_message = settings.cart_free_sample_message | default: 'Add [amount] more to get a free sample!'
  assign success_message = settings.cart_free_sample_message_success | default: 'üéâ Congratulations! Free sample unlocked!'

  # Get actual product object from handle
  if sample_product_setting != blank
    assign sample_product = all_products[sample_product_setting]
  endif

  # Count non-sample items and check if sample is already in cart
  assign non_sample_count = 0
  assign sample_in_cart = false

  for item in cart.items
    if item.product.template_suffix == 'sample'
      continue
    endif

    assign non_sample_count = non_sample_count | plus: 1

    # Check if this item is our sample product (only if we have a sample product defined)
    if sample_product != blank and item.product.id == sample_product.id
      assign sample_in_cart = true
    endif
  endfor

  # Hide component when cart is empty (excluding samples)
  if non_sample_count == 0
    break
  endif

  # Validate that progress message contains the [amount] placeholder
  unless progress_message contains '[amount]'
    echo '<div class="cartFreeSample__error" style="background: #ff6b6b; color: white; padding: 10px; margin: 10px; border-radius: 4px;">‚ö†Ô∏è Error: Progress message must include the [amount] placeholder. Current message: "' | append: progress_message | append: '"</div>'
    break
  endunless

  # Check cart total
  assign cart_total = cart.total_price | default: 0
  assign remaining_amount = threshold | minus: cart_total
  assign progress_percentage = cart_total | times: 100 | divided_by: threshold
%}

{%- liquid
  # Limit percentage to 100%
  if progress_percentage > 100
    assign progress_percentage = 100
  endif
-%}

{% render 'vite-tag' with '@/cart-free-sample.css' %}

<div
  style='--bg-color: {{ settings.cart_free_sample_background_color | default: '#e5e5e538' }}; --cartFreeSampleBarColor: {{ settings.cart_free_sample_bar_color | default: '#1B4A3C' }}; --cartFreeSampleProgressTrackColor: {{ settings.cart_free_sample_progress_track_color | default: '#e5e5e5' }}'
  class='cartFreeSample js-cartFreeSample{% if progress_percentage >= 100 %} cartFreeSample--completed{% endif %}{% if sample_in_cart %} hidden{% endif %}'
  data-threshold='{{ threshold }}'
  data-cart-total='{{ cart_total }}'
  data-sample-product-id='{{ sample_product.variants.first.id }}'
  data-currency='{{ cart.currency.symbol }}'
  data-progress-message='{{ progress_message | escape }}'
  data-success-message='{{ success_message | escape }}'
  role='region'
  aria-label='Free sample progress'
  aria-live='polite'
  aria-atomic='true'
>
  <div class='cartFreeSample__progressContainer'>
    <div
      class='cartFreeSample__progressTrack'
      role='progressbar'
      aria-valuenow='{{ progress_percentage }}'
      aria-valuemin='0'
      aria-valuemax='100'
      aria-label='Progress towards free sample: {{ progress_percentage }}% complete'
    >
      <div
        class='cartFreeSample__progressFill'
        style='width: {{ progress_percentage }}%'
        aria-hidden='true'
      ></div>
    </div>
  </div>

  <div class='cartFreeSample__message' aria-live='polite'>
    {%- if remaining_amount > 0 -%}
      {%- assign remaining_money = remaining_amount | money -%}
      <span class='cartFreeSample__messageText' id='free-sample-progress-text'>
        {{ progress_message | replace: '[amount]', remaining_money }}
      </span>

    {%- else -%}
      <span
        class='cartFreeSample__messageSuccess'
        id='free-sample-success-text'
      >
        {{ success_message }}
      </span>
    {%- endif -%}
  </div>

  {%- if sample_product != blank -%}
    <div
      class='cartFreeSample__product'
      role='group'
      aria-labelledby='free-sample-product-title'
    >
      <img
        src='{{ sample_product.featured_image | image_url: width: 60 }}'
        alt='{{ sample_product.title | escape }}'
        class='cartFreeSample__productImage'
        width='60'
        height='60'
        loading='lazy'
        decoding='async'
      >
      <div class='cartFreeSample__productInfo'>
        <span
          class='cartFreeSample__productTitle'
          id='free-sample-product-title'
        >
          {{- sample_product.title -}}
        </span>
        <span
          class='cartFreeSample__productPrice'
          aria-label='Free sample - no cost'
        >
          {{- 'templates.cart.cart_free_sample_badge_text' | t -}}
        </span>
      </div>
    </div>
  {%- endif -%}
</div>
